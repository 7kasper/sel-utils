language: d

d:
 - dmd
 
script:
 - cd gen
 - rdmd --build-only all.d
 - ./all -no-update
 - cd ..

after_success:
 - MESSAGE=$(git log --format=%B -n 1 $TRAVIS_COMMIT)
 - DESC="Automatically committed from https://github.com/sel-project/sel-utils/commit/${TRAVIS_COMMIT}"
 - git config --global user.email ${EMAIL}
 - git config --global user.name ${USER}
# html (github pages) and json
 - git clone git://${REPO_GP} gp
 - rm -r gp/json
 - cp -r -f pages/. gp
 - cp -r -f json/. gp/json
 - cd gp
 - git add --all .
 - git commit -m "${MESSAGE}" -m "${DESC}"
 - git push "https://${TOKEN}@${REPO_GP}" master
# d
 - cd ..
 - git clone git://${REPO_D} d
 - rm -r d/src
 - cp -r -f src/d/. d/src
 - cd d
 - git add --all .
 - git commit -m "${MESSAGE}" -m "${DESC}"
 - git push "https://${TOKEN}@${REPO_D}" master
 - git tag -a v$(<../gen/.version) -m "${MESSAGE}"
 - git push --tags "https://${TOKEN}@${REPO_D}" master
# java
 - cd ..
 - git clone git://${REPO_JAVA} java
 - rm -r java/src
 - mkdir -p java/src/main/java
 - cp -r -f src/java/. java/src/main/java
 - cd gen && rdmd replace.d ../java/pom.xml.template ../java/pom.xml && cd ..
 - cd java
 - git add --all .
 - git commit -m "${MESSAGE}" -m "${DESC}"
 - git push "https://${TOKEN}@${REPO_JAVA}" master
# js
 - cd ..
 - git clone git://${REPO_JS} js
 - rm -r js/src
 - cp -r -f src/js/. js/src
 - cd gen && rdmd replace.d ../js/package.json.template ../js/package.json && cd ..
 - cd js
 - git add --all .
 - git commit -m "${MESSAGE}" -m "${DESC}"
 - git push "https://${TOKEN}@${REPO_JS}" master
