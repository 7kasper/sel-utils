<?xml version="1.0" encoding="utf-8"?>

<protocol>

	<software>Raknet</software>

	<protocol>8</protocol>

	<description>
		Protocol used by SEL to communicate with external sources using TCP or web sockets.
	</description>

	<encoding id="ubyte" arrayLength="ushort">

		<endianness type="*" value="bigEndian" />
		
		<endianness type="triad" value="littleEndian" />

		<alias name="magic" type="ubyte[16]" />
		
		<type name="address">
			<field name="type" type="ubyte" />
			<field name="ipv4" type="ubyte[4]" when="type==4" />
			<field name="ipv6" type="ubyte[16]" when="type==6" />
			<field name="port" type="ushort" />
		</type>

		<type name="acknowledge">
			<field name="unique" type="bool" />
			<field name="first" type="triad" />
			<field name="last" type="triad" when="unique==false" />
		</type>

		<type name="encapsulation">
			<field name="info" type="ubyte" />
			<field name="length" type="ushort" />
			<field name="messageIndex" type="triad" when="(info&0x7F)>=64" />
			<field name="orderIndex" type="triad" when="(info&0x7F)>=96" />
			<field name="orderChannel" type="ubyte" when="(info&0x7F)>=96" />
			<field name="split" type="split" when="(info&0x10)!=0" />
			<field name="payload" type="bytes" />
		</type>

		<type name="split">
			<field name="count" type="uint" />
			<field name="id" type="ushort" />
			<field name="order" type="uint" />
		</type>

	</encoding>

	<packets>

		<section name="status">

			<packet name="ping" id="1" clientbound="false" serverbound="true">
				<field name="pingId" type="long" />
				<field name="magic" type="magic" />
			</packet>

			<packet name="pong" id="28" clientbound="true" serverbound="false">
				<field name="pingId" type="long" />
				<field name="serverId" type="long" />
				<field name="magic" type="magic" />
				<field name="status" type="string" />
			</packet>

		</section>

		<section name="login">

			<packet name="openConnectionRequest1" id="5" clientbound="false" serverbound="true">
				<field name="magic" type="magic" />
				<field name="protocol" type="ubyte" />
				<field name="mtu" type="bytes" />
			</packet>

			<packet name="openConnectionReply1" id="6" clientbound="true" serverbound="false">
				<field name="magic" type="magic" />
				<field name="serverId" type="long" />
				<field name="security" type="bool" />
				<field name="mtuLength" type="ushort" />
			</packet>

			<packet name="openConnectionRequest2" id="7" clientbound="false" serverbound="true">
				<field name="magic" type="magic" />
				<field name="serverAddress" type="address" />
				<field name="mtuLength" type="ushort" />
				<field name="clientId" type="long" />
			</packet>

			<packet name="openConnectionReply2" id="8" clientbound="true" serverbound="false">
				<field name="magic" type="magic" />
				<field name="serverId" type="long" />
				<field name="serverAddress" type="address" />
				<field name="mtuLength" type="ushort" />
				<field name="security" type="bool" />
			</packet>

			<packet name="clientConnect" id="9" clientbound="false" serverbound="true">
				<field name="clientId" type="long" />
				<field name="pingId" type="long" />
			</packet>

			<packet name="serverHandshake" id="16" clientbound="true" serverbound="false">
				<field name="clientAddress" type="address" />
				<field name="mtuLength" type="ushort" />
				<field name="systemAddresses" type="address[10]" />
				<field name="pingId" type="long" />
				<field name="serverId" type="long" />
			</packet>

			<packet name="clientHandshake" id="19" clientbound="false" serverbound="true">
				<field name="clientAddress" type="address" />
				<field name="systemAddresses" type="address[10]" />
				<field name="pingId" type="long" />
				<field name="clientId" type="long" />
			</packet>

			<packet name="clientCancelConnection" id="21" clientbound="false" serverbound="true" />

		</section>

		<section name="connected">

			<packet name="ping" id="0" clientbound="false" serverbound="true">
				<field name="time" type="long" />
			</packet>

			<packet name="pong" id="3" clientbound="true" serverbound="false">
				<field name="time" type="long" />
			</packet>

			<packet name="ack" id="192" clientbound="true" serverbound="true">
				<field name="packets" type="acknowledge[]" />
			</packet>

			<packet name="nack" id="160" clientbound="true" serverbound="true">
				<field name="packets" type="acknowledge[]" />
			</packet>

			<packet name="encapsulated" id="132" clientbound="true" serverbound="true">
				<field name="count" type="triad" />
				<field name="encapsulation" type="encapsulation" />
			</packet>

			<packet name="mcpePacket" id="254" clientbound="true" serverbound="true">
				<field name="packet" type="bytes" />
			</packet>

		</section>

	</packets>

</protocol>
