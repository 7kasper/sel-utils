/*
 * This file has been automatically generated by sel-utils and
 * released under the GNU General Public License version 3.
 *
 * License: https://github.com/sel-project/sel-utils/blob/master/LICENSE
 * Repository: https://github.com/sel-project/sel-utils
 * Generator: https://github.com/sel-project/sel-utils/blob/master/xml/protocol/externalconsole1.xml
 */
module sul.protocol.externalconsole1.status;

import std.bitmanip : write, peek;
import std.conv : to;
import std.system : Endian;
import std.typetuple : TypeTuple;
import std.typecons : Tuple;
import std.uuid : UUID;

import sul.utils.buffer;
import sul.utils.var;

static import sul.protocol.externalconsole1.types;

alias Packets = TypeTuple!(KeepAlive, UpdateNodes, UpdateStats);

/**
 * Keeps the connection alive and/or calculates the latency. This packet should be
 * sent at least every 5 seconds to avoid the disconnection by the server caused by
 * a timeout and update the latency. The client can send this packet whenever he wants
 * and the server must reply with the same packet with the same field's value.
 */
class KeepAlive : Buffer {

	public enum ubyte ID = 0;

	public enum bool CLIENTBOUND = true;
	public enum bool SERVERBOUND = true;

	public enum string[] FIELDS = ["count"];

	/**
	 * An identifier chosen by the client to calculate the latency.
	 */
	public uint count;

	public pure nothrow @safe @nogc this() {}

	public pure nothrow @safe @nogc this(uint count) {
		this.count = count;
	}

	public pure nothrow @safe ubyte[] encode(bool writeId=true)() {
		_buffer.length = 0;
		static if(writeId){ writeBigEndianUbyte(ID); }
		writeBigEndianUint(count);
		return _buffer;
	}

	public pure nothrow @safe void decode(bool readId=true)() {
		static if(readId){ ubyte _id; _id=readBigEndianUbyte(); }
		count=readBigEndianUint();
	}

	public static pure nothrow @safe KeepAlive fromBuffer(bool readId=true)(ubyte[] buffer) {
		KeepAlive ret = new KeepAlive();
		ret._buffer = buffer;
		ret.decode!readId();
		return ret;
	}

}

/**
 * Updates the list of the nodes connected to the hub, adding or removing one.
 * If the server isn't built following the hub-node structure this packet is never
 * sent.
 */
class UpdateNodes : Buffer {

	public enum ubyte ID = 1;

	public enum bool CLIENTBOUND = true;
	public enum bool SERVERBOUND = false;

	public enum string[] FIELDS = ["action", "node"];

	// action
	public enum ubyte ADD = 0;
	public enum ubyte REMOVE = 1;

	/**
	 * Whether the node should be added or removed from the list of connected nodes.
	 */
	public ubyte action;

	/**
	 * Name of the node.
	 */
	public string node;

	public pure nothrow @safe @nogc this() {}

	public pure nothrow @safe @nogc this(ubyte action, string node=string.init) {
		this.action = action;
		this.node = node;
	}

	public pure nothrow @safe ubyte[] encode(bool writeId=true)() {
		_buffer.length = 0;
		static if(writeId){ writeBigEndianUbyte(ID); }
		writeBigEndianUbyte(action);
		writeBigEndianUshort(cast(ushort)node.length); writeString(node);
		return _buffer;
	}

	public pure nothrow @safe void decode(bool readId=true)() {
		static if(readId){ ubyte _id; _id=readBigEndianUbyte(); }
		action=readBigEndianUbyte();
		ushort bm9kzq=readBigEndianUshort(); node=readString(bm9kzq);
	}

	public static pure nothrow @safe UpdateNodes fromBuffer(bool readId=true)(ubyte[] buffer) {
		UpdateNodes ret = new UpdateNodes();
		ret._buffer = buffer;
		ret.decode!readId();
		return ret;
	}

}

class UpdateStats : Buffer {

	public enum ubyte ID = 2;

	public enum bool CLIENTBOUND = true;
	public enum bool SERVERBOUND = false;

	public enum string[] FIELDS = ["onlinePlayers", "maxPlayers", "uptime", "upload", "download", "nodes"];

	public uint onlinePlayers;
	public uint maxPlayers;
	public uint uptime;
	public uint upload;
	public uint download;
	public sul.protocol.externalconsole1.types.NodeStats[] nodes;

	public pure nothrow @safe @nogc this() {}

	public pure nothrow @safe @nogc this(uint onlinePlayers, uint maxPlayers=uint.init, uint uptime=uint.init, uint upload=uint.init, uint download=uint.init, sul.protocol.externalconsole1.types.NodeStats[] nodes=(sul.protocol.externalconsole1.types.NodeStats[]).init) {
		this.onlinePlayers = onlinePlayers;
		this.maxPlayers = maxPlayers;
		this.uptime = uptime;
		this.upload = upload;
		this.download = download;
		this.nodes = nodes;
	}

	public pure nothrow @safe ubyte[] encode(bool writeId=true)() {
		_buffer.length = 0;
		static if(writeId){ writeBigEndianUbyte(ID); }
		writeBigEndianUint(onlinePlayers);
		writeBigEndianUint(maxPlayers);
		writeBigEndianUint(uptime);
		writeBigEndianUint(upload);
		writeBigEndianUint(download);
		writeBigEndianUshort(cast(ushort)nodes.length); foreach(bm9kzxm;nodes){ bm9kzxm.encode(bufferInstance); }
		return _buffer;
	}

	public pure nothrow @safe void decode(bool readId=true)() {
		static if(readId){ ubyte _id; _id=readBigEndianUbyte(); }
		onlinePlayers=readBigEndianUint();
		maxPlayers=readBigEndianUint();
		uptime=readBigEndianUint();
		upload=readBigEndianUint();
		download=readBigEndianUint();
		nodes.length=readBigEndianUshort(); foreach(ref bm9kzxm;nodes){ bm9kzxm.decode(bufferInstance); }
	}

	public static pure nothrow @safe UpdateStats fromBuffer(bool readId=true)(ubyte[] buffer) {
		UpdateStats ret = new UpdateStats();
		ret._buffer = buffer;
		ret.decode!readId();
		return ret;
	}

}
